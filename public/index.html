<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Feel String</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
    <meta name="theme-color" content="#111111" />
    <meta name="mobile-web-app-capable" content="yes" />
    <link rel="manifest" href="manifest.webmanifest" />

    <style>
        :root {
            --bg: #050608;
            --bg-soft: #111320;
            --accent: #ffb347;
            --accent-soft: rgba(255, 179, 71, 0.12);
            --text: #f5f5f7;
            --muted: #9ea2b5;
            --radius: 16px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
            background: radial-gradient(circle at top, #1f2233 0, #050608 55%);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            align-items: stretch;
            justify-content: center;
            font-size: 0.92rem;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .app {
            width: 100%;
            max-width: 480px;
            margin: 0 auto;
            padding: 8px 8px 12px;
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        header h1 {
            font-size: 1.05rem;
            margin: 0;
            letter-spacing: 0.03em;
        }

        header small {
            font-size: 0.65rem;
            color: var(--muted);
        }

        .pill {
            padding: 4px 10px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.04);
            font-size: 0.7rem;
            color: var(--muted);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .brand-logo {
            width: 1.5em;
            height: 1.5em;
            margin-left: 6px;
            vertical-align: middle;
        }

        .emotions {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 8px;
        }

        .emotion-section {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .emotion-btn {
            border: none;
            outline: none;
            border-radius: var(--radius);
            padding: 8px 4px;
            background: rgba(255, 255, 255, 0.03);
            color: var(--text);
            font-size: 0.78rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.09s ease, background 0.12s ease, box-shadow 0.12s ease;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            -webkit-tap-highlight-color: transparent;
        }

        .emotion-btn span.emoji {
            font-size: 1rem;
        }

        .emotion-btn span.label {
            opacity: 0.9;
            font-size: 0.7rem;
        }

        .emotion-btn.active {
            background: linear-gradient(135deg, var(--accent-soft), rgba(255, 255, 255, 0.05));
            box-shadow: 0 14px 30px rgba(0, 0, 0, 0.5);
            transform: translateY(-1px) scale(1.02);
        }

        .emotion-btn:active {
            transform: translateY(1px) scale(0.98);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.6);
        }

        .panel {
            background: rgba(5, 6, 12, 0.9);
            border-radius: 18px;
            padding: 6px 6px 6px;
            border: 1px solid rgba(255, 255, 255, 0.06);
            box-shadow: 0 16px 32px rgba(0, 0, 0, 0.65);
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }

        .panel-actions {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        button.round.favorite-btn {
            background: rgba(255, 255, 255, 0.08);
            color: var(--accent);
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-width: 28px;
            padding: 4px 8px;
        }

        button.round.favorite-btn.hearted {
            background: rgba(255, 255, 255, 0.18);
            border-color: var(--accent);
            color: var(--accent);
        }

        .panel-header-left {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .panel-title {
            font-size: 0.7rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--muted);
        }

        .panel-current {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .progression {
            margin-top: 4px;
            padding: 4px 4px 3px;
            border-radius: 14px;
            background: rgba(255, 255, 255, 0.02);
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            min-height: 32px;
        }

        .progression-row {
            display: flex;
            align-items: flex-start;
            gap: 2px;
        }

        .transpose-stack {
            display: flex;
            flex-direction: row;
            gap: 6px;
            align-items: center;
            justify-content: center;
            margin-left: auto;
        }

        .transpose-stack button {
            border: 1px solid rgba(255, 255, 255, 0.18);
            background: rgba(0, 0, 0, 0.3);
            color: var(--text);
            border-radius: 999px;
            width: 26px;
            height: 26px;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .transpose-stack button:disabled {
            opacity: 0.35;
            cursor: not-allowed;
        }

        .transpose-value {
            font-size: 13px;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--muted);
        }

        .chord-pill {
            padding: 2px 2px;
            min-height: 26px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.18);
            font-size: 13px;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(6px);
            cursor: pointer;
        }

        .chord-drawer {
            margin-top: 6px;
            border-radius: 14px;
            padding: 8px 8px 10px;
            border: 1px solid rgba(255, 179, 71, 0.25);
            background: rgba(0, 0, 0, 0.35);
        }

        .chord-drawer[hidden] {
            display: none;
        }

        .chord-drawer__header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.72rem;
            color: var(--muted);
            padding-bottom: 4px;
        }

        .chord-drawer__close {
            border: none;
            background: transparent;
            color: var(--muted);
            font-size: 1rem;
            cursor: pointer;
            line-height: 1;
        }

        .chord-drawer__grid {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            justify-content: space-between;
        }

        .chord-card {
            flex: 1 1 22%;
            min-width: 60px;
            max-width: 90px;
            border-radius: 10px;
            border: 1px solid transparent;
            padding: 2px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            cursor: pointer;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .chord-card.is-active {
            border-color: var(--accent);
        }

        .chord-card__svg {
            width: 100%;
            height: 80px;
        }

        .chord-card__label {
            font-size: 0.65rem;
            color: var(--text);
        }

        .style-picker {
            margin-top: 8px;
            padding: 8px 10px;
            border-radius: 14px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .style-picker__label-row {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            gap: 6px;
        }

        .style-picker__label {
            font-size: 0.75rem;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: var(--muted);
        }

        .style-picker__helper {
            font-size: 0.65rem;
            color: var(--muted);
        }

        .style-picker__options {
            padding-top: 4px;
            display: flex;
            gap: 2px;
        }

        .style-btn {
            flex: 1;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.18);
            background: transparent;
            color: var(--text);
            font-size: 0.78rem;
            padding: 4px 8px;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.15s ease, border-color 0.2s ease;
        }

        .style-btn.active {
            background: rgba(255, 179, 71, 0.15);
            border-color: rgba(255, 179, 71, 0.6);
            transform: translateY(-1px);
        }

        .style-btn:active {
            transform: translateY(1px);
        }

        .chord-modal {
            position: fixed;
            inset: 0;
            display: none;
            z-index: 50;
            align-items: stretch;
            justify-content: center;
            padding: 0;
        }

        .chord-modal.is-visible {
            display: flex;
        }

        .chord-modal__backdrop {
            position: absolute;
            inset: 0;
            background: rgba(5, 6, 12, 0.95);
        }

        .chord-modal__content {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: none;
            max-height: none;
            border-radius: 0;
            background: rgba(5, 6, 12, 0.95);
            border: none;
            box-shadow: none;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 0;
            overflow: hidden;
        }

        .chord-modal__grid {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 6px;
        }

        .chord-modal__header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            color: var(--muted);
            font-size: 0.72rem;
        }

        .chord-modal__close {
            border: none;
            background: rgba(255, 255, 255, 0.08);
            color: var(--text);
            border-radius: 999px;
            padding: 4px 8px;
            cursor: pointer;
        }

        button.round {
            border-radius: 999px;
            border: none;
            padding: 4px 10px;
            font-size: 0.75rem;
            background: var(--accent);
            color: #201b0d;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.7);
            -webkit-tap-highlight-color: transparent;
        }

        button.round:active {
            transform: translateY(1px) scale(0.97);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.85);
        }

        .install-banner {
            position: fixed;
            inset: auto 16px 24px;
            padding: 12px 14px;
            border-radius: 16px;
            background: rgba(5, 6, 12, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.35);
            opacity: 0;
            pointer-events: none;
            transform: translateY(16px);
            transition: opacity 0.2s ease, transform 0.2s ease;
            z-index: 10;
        }

        .install-banner.is-visible {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }

        .install-banner .text {
            flex: 1;
            font-size: 0.8rem;
            color: var(--text);
        }

        .install-banner button {
            border: none;
            background: rgba(255, 255, 255, 0.08);
            color: var(--text);
            border-radius: 999px;
            padding: 6px 12px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .install-banner button:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .install-banner button.dismiss {
            background: transparent;
            font-size: 1rem;
            padding: 2px 6px;
        }

        .play-meta {
            margin-top: 4px;
            padding-top: 2px;
            border-top: 1px dashed rgba(255, 255, 255, 0.15);
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 0.68rem;
        }

        .meta-row {
            display: flex;
            gap: 6px;
            align-items: baseline;
        }

        .meta-label {
            text-transform: uppercase;
            letter-spacing: 0.12em;
            font-size: 0.62rem;
            color: var(--muted);
            min-width: 60px;
        }

        .meta-value {
            flex: 1;
            color: var(--text);
        }

        #metaName {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .meta-small {
            font-size: 0.7rem;
            color: var(--muted);
        }
    </style>
</head>

<body>
    <div class="app">
        <header>
            <div>
                <h1>Feel String
                    <img src="assets/icons/logo.svg" alt="Feel String logo" class="brand-logo" />
                </h1>
                <small>Tap a feeling ‚Üí random progression</small>
            </div>
            <div class="pill">v2025.12.29</div>
        </header>

        <section class="emotion-section">
            <div class="emotions" id="emotions">
                <button class="emotion-btn" data-emotion="happy">
                    <span class="emoji">üòä</span>
                    <span class="label">Happy</span>
                </button>
                <button class="emotion-btn" data-emotion="sad">
                    <span class="emoji">üò¢</span>
                    <span class="label">Sad</span>
                </button>
                <button class="emotion-btn" data-emotion="inspired">
                    <span class="emoji">‚ú®</span>
                    <span class="label">Inspired</span>
                </button>
                <button class="emotion-btn" data-emotion="anger">
                    <span class="emoji">üò°</span>
                    <span class="label">Anger</span>
                </button>
                <button class="emotion-btn" data-emotion="ashamed">
                    <span class="emoji">üôà</span>
                    <span class="label">Ashamed</span>
                </button>
                <button class="emotion-btn" data-emotion="loved">
                    <span class="emoji">‚ù§Ô∏è</span>
                    <span class="label">Loved</span>
                </button>
            </div>
            <div class="style-picker">
                <div class="style-picker__label-row">
                    <span class="style-picker__label">Guitar styles</span>
                </div>
                <div class="style-picker__options">
                    <button type="button" class="style-btn active" data-style="rock">Rock üé∏</button>
                    <button type="button" class="style-btn active" data-style="jazz">Jazz üé∑</button>
                    <button type="button" class="style-btn active" data-style="blues">Blues üé∫</button>
                </div>
            </div>
        </section>

        <section class="panel">
            <div class="panel-header">
                <div class="panel-header-left">
                    <span class="panel-title">Chord progression</span>
                    <span class="panel-current" id="metaName">‚Äî</span>
                </div>
                <div class="panel-actions">
                    <button class="round favorite-btn" id="favoriteBtn" aria-pressed="false"
                        aria-label="Favorite chord progression">
                        ‚ô°
                    </button>
                    <button class="round" id="replayBtn" disabled>
                        ‚ñ∂Ô∏é Replay
                    </button>
                </div>
            </div>

            <div class="progression-row">
                <div class="progression" id="progression"></div>
                <div class="progression transpose-stack" aria-label="Transpose chords">
                    <button type="button" class="transpose-btn" data-transpose-action="decrement"
                        aria-label="Transpose down one semitone">‚àí</button>
                    <span class="transpose-value" id="transposeValue">0</span>
                    <button type="button" class="transpose-btn" data-transpose-action="increment"
                        aria-label="Transpose up one semitone">+</button>
                </div>
            </div>
            <div class="chord-drawer" id="chordDrawer">
                <div class="chord-drawer__header">
                    <span>Chord diagrams</span>
                </div>
                <div class="chord-drawer__grid" id="chordDrawerGrid"></div>
            </div>
            <div class="play-meta">
                <div class="meta-row">
                    <span class="meta-label">Strum</span>
                    <span class="meta-value" id="metaPattern">‚Äî</span>
                </div>
                <div class="meta-row">
                    <span class="meta-label">Technique</span>
                    <span class="meta-value" id="metaTechnique">‚Äî</span>
                </div>
            </div>

        </section>
    </div>

    <div class="install-banner" id="installBanner" aria-live="polite">
        <div class="text">Install Feel String for quick access & offline practice.</div>
        <button id="installBtn">Install</button>
        <button class="dismiss" id="installDismiss" aria-label="Dismiss install prompt">√ó</button>
    </div>

    <div class="chord-modal" id="chordModal" aria-hidden="true">
        <div class="chord-modal__backdrop"></div>
        <div class="chord-modal__content">
            <div class="chord-modal__header">
                <span>Select replacement chord</span>
                <button class="chord-modal__close" id="chordModalClose" type="button"
                    aria-label="Close chord picker">√ó</button>
            </div>
            <div class="chord-drawer__grid chord-modal__grid" id="chordModalGrid"></div>
        </div>
    </div>

    <script>
        // ---------- Note frequencies ----------
        const noteFreq = {
            C3: 130.81, D3: 146.83, E3: 164.81, F3: 174.61, G3: 196.00, A3: 220.00, B3: 246.94,
            C4: 261.63, D4: 293.66, E4: 329.63, F4: 349.23, G4: 392.00, A4: 440.00, B4: 493.88
        };

        const noteNameToSemitone = {
            C: 0, "C#": 1, Db: 1, D: 2, "D#": 3, Eb: 3, E: 4, Fb: 4, "E#": 5, F: 5, "F#": 6, Gb: 6,
            G: 7, "G#": 8, Ab: 8, A: 9, "A#": 10, Bb: 10, B: 11, Cb: 11
        };
        const sharpNoteNames = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];

        function getNoteFrequency(noteName) {
            if (noteFreq[noteName]) {
                return noteFreq[noteName];
            }
            const match = noteName.match(/^([A-G](?:#|b)?)(\d)$/);
            if (!match) return null;
            const [, letter, octaveStr] = match;
            const semitone = noteNameToSemitone[letter];
            if (semitone === undefined) return null;
            const octave = Number(octaveStr);
            const midiNumber = (octave + 1) * 12 + semitone;
            const freq = 440 * Math.pow(2, (midiNumber - 69) / 12);
            noteFreq[noteName] = freq;
            return freq;
        }

        function transposeNoteName(note, offset) {
            const semitone = noteNameToSemitone[note];
            if (semitone === undefined) return note;
            const normalized = (semitone + offset + 12) % 12;
            return sharpNoteNames[normalized] || note;
        }

        function transposeChordName(chordName, offset) {
            if (!offset) return chordName;
            const [main, bass] = chordName.split("/");
            const match = main.match(/^([A-G](?:#|b)?)(.*)$/);
            if (!match) return chordName;
            const [, root, suffix] = match;
            const transposedRoot = transposeNoteName(root, offset);
            let result = transposedRoot + (suffix || "");
            if (bass) {
                const transposedBass = transposeNoteName(bass, offset);
                result += `/${transposedBass}`;
            }
            return result;
        }

        // ---------- Chord voicings (simple, open-ish) ----------
        const CUSTOM_PROGRESSIONS_KEY = "feel-string-chord-progressions";
        const FAVORITE_PROGRESSIONS_KEY = "feel-string-loved-progressions";

        function loadPersistedMap(key) {
            try {
                const raw = localStorage.getItem(key);
                return raw ? JSON.parse(raw) : {};
            } catch (err) {
                return {};
            }
        }

        function persistMap(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (err) {
                // ignore private mode restrictions
            }
        }

        const customChordProgressions = loadPersistedMap(CUSTOM_PROGRESSIONS_KEY);
        const favoriteProgressions = loadPersistedMap(FAVORITE_PROGRESSIONS_KEY);

        const chords = {
            // C family
            C: ["C4", "E4", "G4"],
            Csus2: ["C4", "D4", "G4"],
            Csus4: ["C4", "F4", "G4"],
            Cmaj7: ["C4", "E4", "B4"],
            Cadd9: ["C4", "E4", "D4"],
            // G family
            G: ["G3", "B3", "D4"],
            Gsus4: ["G3", "C4", "D4"],
            G7: ["G3", "B3", "D4", "F4"],
            Gadd9: ["G3", "A3", "D4"],
            // A family
            Am: ["A3", "C4", "E4"],
            Am7: ["A3", "C4", "E4", "G4"],
            A: ["A3", "C#4", "E4"], // approximate, uses C4 but it's OK for prototype
            A7: ["A3", "C4", "E4", "G4"],
            // F family
            F: ["F3", "A3", "C4"],
            Fmaj7: ["F3", "A3", "C4", "E4"],
            Fsus2: ["F3", "G3", "C4"],
            // D family
            Dm: ["D3", "F3", "A3"],
            Dm7: ["D3", "F3", "A3", "C4"],
            D: ["D3", "F#3", "A3"], // approx
            D7: ["D3", "F3", "A3", "C4"],
            // E family
            Em: ["E3", "G3", "B3"],
            Em7: ["E3", "G3", "B3", "D4"],
            E: ["E3", "G#3", "B3"], // approx
            E7: ["E3", "G3", "B3", "D4"],
            // small extras
            Bdim: ["B3", "D4", "F4"],
            Bb: ["Bb3", "D4", "F4"], // may be silent if Bb3 missing but fine for prototype
            Bbmaj7: ["Bb3", "D4", "F4", "A4"],
            E5: ["E3", "B3", "E4"],
            A5: ["A3", "E4", "A4"],
            G5: ["G3", "D4", "G4"]
        };
        const chordOptions = Object.keys(chords).sort((a, b) => a.localeCompare(b));
        const LONG_PRESS_DELAY = 420;

        // ---------- Emotions & 10 progressions each ----------
        // strum pattern legend examples: D = down, U = up, x = muted, H = hammer-on, P = pull-off
        const guitarStyles = {
            rock: {
                emoji: "üé∏",
                label: "Rock",
                summary: "Aggressive, chunky downstrokes with tight chokes.",
                patternSuffix: "(Rock swing: add extra downstroke punch).",
                techniqueNote: "Lean into palm-mutes and heavy downstrokes near the bridge.",
                extraNote: "End each turn with a muted chop for extra bite."
            },
            jazz: {
                emoji: "üé∑",
                label: "Jazz",
                summary: "Laid-back swing, syncopated accents, and inner-voice focus.",
                patternSuffix: "(Jazz sway: syncopated upstrokes and light swings).",
                techniqueNote: "Keep fingers close to the strings and emphasise inner voices.",
                extraNote: "Add subtle ghost notes between chords to keep the pocket breathing."
            },
            blues: {
                emoji: "üé∫",
                label: "Blues",
                summary: "Shuffle-driven, call-and-response phrasing with spacey bends.",
                patternSuffix: "(Blues shuffle: long-short, long-short feel).",
                techniqueNote: "Let the wrist sway, accent beats 2 and 4, and add slinky rubs.",
                extraNote: "Let the 3rd and 7th linger and finish phrases with a soft percussive hit."
            }
        };

        const stylePairData = [
            {
                emotions: ["happy", "inspired"],
                rock: {
                    name: "Power Pop Pulse",
                    chords: ["C", "G", "Am", "F"],
                    pattern: "D D U U D U",
                    technique: "Drive the downbeats, keep the wrist tight for punch.",
                    extra: "Let each chord ring, then finish with a muted lift on beat 4."
                },
                jazz: {
                    name: "Daylight Bloom",
                    chords: ["Cmaj7", "G7", "Am7", "Fmaj7"],
                    pattern: "D (D U) (D U)",
                    technique: "Play with thumbed bass and airy comping.",
                    extra: "Let the top strings float, emphasising the inner voices."
                },
                blues: {
                    name: "Shine Delta",
                    chords: ["C", "G7", "Am7", "F"],
                    pattern: "D U D U D U",
                    technique: "Thumb the low strings and brush the highs softly.",
                    extra: "Stack short walk-ups between chords for a warm shuffle."
                }
            },
            {
                emotions: ["happy", "loved"],
                rock: {
                    name: "Sunset Anthem",
                    chords: ["G", "D", "Em", "C"],
                    pattern: "D D U xD D",
                    technique: "Chunky downstrokes with bright, ringing tops.",
                    extra: "End each bar with a quick muted chop to keep energy."
                },
                jazz: {
                    name: "Velvet Circuit",
                    chords: ["C", "G/B", "Am7", "Fmaj7"],
                    pattern: "D U D U",
                    technique: "Roll from bass to treble for soft comping.",
                    extra: "Add ghost notes on the weak beats to keep your hand moving."
                },
                blues: {
                    name: "Honey Swell",
                    chords: ["F", "C", "G7", "C"],
                    pattern: "D D U U D U",
                    technique: "Lay into the shuffle with low-thumb grooves.",
                    extra: "Slide into the G7 to highlight the call-and-response."
                }
            },
            {
                emotions: ["happy", "anger"],
                rock: {
                    name: "Crash Rally",
                    chords: ["E5", "G5", "A5", "G5"],
                    pattern: "D D D D",
                    technique: "All downstrokes with tight palm muting.",
                    extra: "Let each chord chug, then release a split second after the hit."
                },
                jazz: {
                    name: "Brass Sparks",
                    chords: ["Em7", "A7", "Dm7", "G7"],
                    pattern: "D D U D U",
                    technique: "Accent the A7 on beat two with snapped attack.",
                    extra: "Let the Em7 breathe before sliding into the Dm7."
                },
                blues: {
                    name: "Rusty Anthem",
                    chords: ["E7", "G7", "A7", "G7"],
                    pattern: "D D D D",
                    technique: "Steady shuffle with aggressive thumb-driving bass.",
                    extra: "Queue up the A7 with a punchy accent before returning to G7."
                }
            },
            {
                emotions: ["happy", "sad"],
                rock: {
                    name: "Helix Lift",
                    chords: ["Am", "F", "C", "G"],
                    pattern: "D D U U D U",
                    technique: "Let the treble strings ring while keeping bass anchored.",
                    extra: "Sustain the final G to create a bittersweet feel."
                },
                jazz: {
                    name: "Glass Garden",
                    chords: ["Am7", "D7", "G", "Cmaj7"],
                    pattern: "D (D U) U D",
                    technique: "Let the D7 sit slightly behind the beat.",
                    extra: "Allow the Cmaj7 to bloom with a slow release."
                },
                blues: {
                    name: "Tears in Satin",
                    chords: ["Cadd9", "G", "Am7", "Fmaj7"],
                    pattern: "D D U U D U",
                    technique: "Brush the strings gently, intimate and open.",
                    extra: "Play a soft hammer-on on the G chord to let it cry."
                }
            },
            {
                emotions: ["happy", "ashamed"],
                rock: {
                    name: "Glass Horizon",
                    chords: ["Cadd9", "G", "Em", "D"],
                    pattern: "D U D U D U",
                    technique: "Open strums with relaxed palm cushioning.",
                    extra: "Insert a small hook of open strings between each bar."
                },
                jazz: {
                    name: "Quiet Resolve",
                    chords: ["Dm7", "G7", "Cmaj7", "Bbmaj7"],
                    pattern: "D U D U",
                    technique: "Keep the touch gentle and even-paced.",
                    extra: "Let the Bbmaj7 ring as a soft sigh before resolving."
                },
                blues: {
                    name: "Borrowed Smile",
                    chords: ["C", "G/B", "Am7", "Fmaj7"],
                    pattern: "D D U xU D",
                    technique: "Swing each bar with a breathing shuffle.",
                    extra: "Let G/B lead gracefully back into the Fmaj7 landing."
                }
            },
            {
                emotions: ["inspired", "loved"],
                rock: {
                    name: "Neon Bloom",
                    chords: ["Cmaj7", "Fmaj7", "G", "Em7"],
                    pattern: "D (D U) (D U)",
                    technique: "Start with tall, open strums then settle into the groove.",
                    extra: "Blend the Em7 into the loop for a warm landing."
                },
                jazz: {
                    name: "Luminous Waltz",
                    chords: ["Fmaj7", "G7", "Em7", "Am7"],
                    pattern: "D D U  U D",
                    technique: "Treat the bar like a three-beat sway.",
                    extra: "Walk the bass lightly between chords for shimmer."
                },
                blues: {
                    name: "Evening Train",
                    chords: ["D7", "G", "C", "Am7"],
                    pattern: "D D U D",
                    technique: "Punch the D7, then brush across high strings.",
                    extra: "Let the G stretch before dropping into C for the ride."
                }
            },
            {
                emotions: ["inspired", "anger"],
                rock: {
                    name: "Voltage Push",
                    chords: ["Em", "Cmaj7", "G", "D"],
                    pattern: "D xD D xD",
                    technique: "Staccato hits with aggressive palm damping.",
                    extra: "Cut chords tight right after each strike."
                },
                jazz: {
                    name: "Circuit Turning",
                    chords: ["Em7", "Cmaj7", "Am7", "D7"],
                    pattern: "D U D U",
                    technique: "Keep fingers close to strings for quick voicing changes.",
                    extra: "Let the D7 drop in with a slight syncopation."
                },
                blues: {
                    name: "Steel Swamp",
                    chords: ["E7", "E7", "G7", "A7"],
                    pattern: "D D D D",
                    technique: "Heavily swung downstrokes with thumb anchor.",
                    extra: "Throw in a sly hammer-on before landing on A7."
                }
            },
            {
                emotions: ["inspired", "sad"],
                rock: {
                    name: "Lone Beacon",
                    chords: ["Am7", "Dm7", "G", "C"],
                    pattern: "D U D U",
                    technique: "Let the higher strings breathe while bass stays grounded.",
                    extra: "Shift dynamics slowly to keep the story moving."
                },
                jazz: {
                    name: "Blue Lantern",
                    chords: ["Am7", "Dm7", "G7", "Cmaj7"],
                    pattern: "D (D U) U U",
                    technique: "Use thumb-led bass and floating top strings.",
                    extra: "Lean on the G7 as the pivot before resolving to Cmaj7."
                },
                blues: {
                    name: "Amber Drift",
                    chords: ["Am7", "Em7", "Fmaj7", "G7"],
                    pattern: "D D U  U D",
                    technique: "Let the bass hum while the treble dances.",
                    extra: "Add a soft pull-off between the Fmaj7 and G7."
                }
            },
            {
                emotions: ["inspired", "ashamed"],
                rock: {
                    name: "Fading Triumph",
                    chords: ["Dm7", "G7", "Cmaj7", "Cmaj7"],
                    pattern: "D D U U",
                    technique: "Keep the attack deliberate and unwavering.",
                    extra: "Allow the final Cmaj7 to drift longer than usual."
                },
                jazz: {
                    name: "Soft Inquiry",
                    chords: ["Bbmaj7", "Am7", "D7", "G7"],
                    pattern: "D U D  U",
                    technique: "Feather each stroke, staying light on the fretboard.",
                    extra: "Treat the Bbmaj7 as a warm, questioning hug."
                },
                blues: {
                    name: "Lowlight Linger",
                    chords: ["Dm7", "G7", "Cadd9", "Fmaj7"],
                    pattern: "D U D U",
                    technique: "Accent the backbeat while keeping muted plucks in-between.",
                    extra: "Let Cadd9 sit longer to stretch the melancholy."
                }
            },
            {
                emotions: ["loved", "anger"],
                rock: {
                    name: "Velvet Riot",
                    chords: ["Am", "G", "F", "E"],
                    pattern: "D D xD xD",
                    technique: "Alternate between loud and muted hits for tension.",
                    extra: "Finish on E with a quick choke to keep it raw."
                },
                jazz: {
                    name: "Crimson Lure",
                    chords: ["Cmaj7", "Bbmaj7", "Fmaj7", "G7"],
                    pattern: "D (D U) D U",
                    technique: "Let the G7 shine with slightly bigger attack.",
                    extra: "Bbmaj7 adds the tension before the calm release."
                },
                blues: {
                    name: "Love on Fire",
                    chords: ["Am", "F", "G", "E7"],
                    pattern: "D D U D",
                    technique: "Thumb-heavy bass with tight treble snaps.",
                    extra: "E7 should hang with a slight feedback-like sustain."
                }
            },
            {
                emotions: ["loved", "sad"],
                rock: {
                    name: "Tender Cut",
                    chords: ["C", "G/B", "Am7", "Fmaj7"],
                    pattern: "D D U xU D",
                    technique: "Trace each chord slowly from the bass up.",
                    extra: "G/B gives a sweet lift before sinking to Fmaj7."
                },
                jazz: {
                    name: "Silk Retreat",
                    chords: ["Fmaj7", "Em7", "Am7", "G7"],
                    pattern: "D U D   U U",
                    technique: "Keep the top strings sweet and mellow.",
                    extra: "Em7 to Am7 is the heartbeat of this line."
                },
                blues: {
                    name: "Tender Cry",
                    chords: ["Cmaj7", "Fmaj7", "G7", "C"],
                    pattern: "D D U U",
                    technique: "Arpeggiate the Cmaj7 for a lullaby feel.",
                    extra: "Drop back to C with a soft thumb to finish."
                }
            },
            {
                emotions: ["loved", "ashamed"],
                rock: {
                    name: "Glow Aftermath",
                    chords: ["Fmaj7", "G", "Em7", "Am7"],
                    pattern: "D (arp) D U",
                    technique: "Start each bar with an arpeggio then strum.",
                    extra: "Pause before hitting Em7 to let the voices settle."
                },
                jazz: {
                    name: "Moonlit Couplet",
                    chords: ["Dm7", "G7", "Cmaj7", "Am7"],
                    pattern: "D D U U",
                    technique: "Dial in a gentle backbeat with touches of chromatic passing notes.",
                    extra: "Cmaj7 opens and the Am7 closes like verses."
                },
                blues: {
                    name: "Green Lantern",
                    chords: ["Fmaj7", "G7", "Em7", "Am7"],
                    pattern: "D U D U",
                    technique: "Slide smoothly into each chord with a light two-finger hook.",
                    extra: "Keep the G7 slightly damped for a smoky finish."
                }
            },
            {
                emotions: ["anger", "sad"],
                rock: {
                    name: "Steel March",
                    chords: ["Em", "D", "C", "D"],
                    pattern: "D D xD xD",
                    technique: "Palm-mute for a marching pulse with occasional ring-outs.",
                    extra: "Open the last D to let it breathe before looping."
                },
                jazz: {
                    name: "Tension Glide",
                    chords: ["G7", "Fmaj7", "Em7", "D7"],
                    pattern: "D D U D U",
                    technique: "Center the groove around the G7 top voice.",
                    extra: "Drop right into the D7 for a sharp turn-around."
                },
                blues: {
                    name: "Broken Train",
                    chords: ["Em7", "D", "C", "D"],
                    pattern: "D D U D",
                    technique: "Let each chord slide toward the next for grit.",
                    extra: "Pull the D down into C like slowing cars."
                }
            },
            {
                emotions: ["anger", "ashamed"],
                rock: {
                    name: "Tension Fold",
                    chords: ["Am7", "C", "G", "F"],
                    pattern: "D (choke) D (choke)",
                    technique: "Choke after each throw to keep attack jittery.",
                    extra: "Lean into the uncertainty of each muted hit."
                },
                jazz: {
                    name: "Hushed Edges",
                    chords: ["Am7", "Cmaj7", "Fmaj7", "G7"],
                    pattern: "D U D U",
                    technique: "Keep strokes brushed and light.",
                    extra: "Let the G7 float before it snaps back into Am7."
                },
                blues: {
                    name: "Smokestack Frown",
                    chords: ["Am", "G", "F", "E7"],
                    pattern: "D xD D xD",
                    technique: "Mimic a train chug with alternate muted hits.",
                    extra: "End each bar with the E7 ring-linger."
                }
            },
            {
                emotions: ["sad", "ashamed"],
                rock: {
                    name: "Last Ember",
                    chords: ["Em7", "Dm7", "Cmaj7", "Am7"],
                    pattern: "D U D U",
                    technique: "Slow, airy strums that fade into the next chord.",
                    extra: "Allow the chords to overlap lightly for warmth."
                },
                jazz: {
                    name: "Faded Promise",
                    chords: ["Dm7", "Em7", "Fmaj7", "G7"],
                    pattern: "D U D U",
                    technique: "Use soft thumb strokes with careful inner voices.",
                    extra: "Drop the G7 a beat late to keep the yearning alive."
                },
                blues: {
                    name: "Midnight Lull",
                    chords: ["Em7", "Dm7", "Cmaj7", "Bdim"],
                    pattern: "D (soft) D U",
                    technique: "Keep things close-mic with gentle damped hits.",
                    extra: "Let the Bdim be a quick, short stop before resolving."
                }
            }
        ];

        function buildStyleProgressions(styleKey) {
            return stylePairData.map(pair => {
                const emotions = pair.emotions.filter(key => key !== "loved");
                return {
                    ...pair[styleKey],
                    emotions
                };
            });
        }

        const styleProgressions = {
            rock: buildStyleProgressions("rock"),
            jazz: buildStyleProgressions("jazz"),
            blues: buildStyleProgressions("blues")
        };

        const chordDiagrams = {
            C: { positions: [-1, 3, 2, 0, 1, 0] },
            Cadd9: { positions: [-1, 3, 2, 0, 3, 0] },
            Cmaj7: { positions: [-1, 3, 2, 0, 0, 0] },
            Am: { positions: [-1, 0, 2, 2, 1, 0] },
            Am7: { positions: [-1, 0, 2, 0, 1, 0] },
            A5: { positions: [-1, 0, 2, 2, -1, -1] },
            A7: { positions: [0, 2, 0, 2, 0, 0] },
            Bbmaj7: { positions: [1, 1, 3, 2, 3, 1], barre: { fret: 1, from: 1, to: 5 } },
            Bdim: { positions: [-1, 2, 3, 1, 3, 1] },
            D: { positions: [-1, -1, 0, 2, 3, 2] },
            D7: { positions: [-1, -1, 0, 2, 1, 2] },
            Dm7: { positions: [-1, -1, 0, 2, 1, 1] },
            E: { positions: [0, 2, 2, 1, 0, 0] },
            E5: { positions: [0, 2, 2, -1, -1, -1] },
            E7: { positions: [0, 2, 0, 1, 0, 0] },
            Em: { positions: [0, 2, 2, 0, 0, 0] },
            Em7: { positions: [0, 2, 0, 0, 3, 0] },
            F: { positions: [1, 3, 3, 2, 1, 1], barre: { fret: 1, from: 1, to: 6 } },
            Fmaj7: { positions: [1, 3, 3, 2, 1, 0], barre: { fret: 1, from: 1, to: 5 } },
            G: { positions: [3, 2, 0, 0, 0, 3] },
            "G/B": { positions: [-1, 2, 0, 0, 0, 3] },
            G5: { positions: [3, 5, 5, -1, -1, -1] },
            G7: { positions: [3, 2, 0, 0, 0, 1] }
        };
        let currentActiveChord = null;
        let currentProgChords = [];
        let currentTransposedChords = [];
        let currentActiveChordIndex = 0;
        let currentProgressionKey = null;
        let currentProgRef = null;
        let modalTargetChordIndex = null;
        const CHORD_SVG_NS = "http://www.w3.org/2000/svg";

        const baseEmotions = {
            happy: {
                label: "Happy",
                emoji: "üòä",
                description: "Bright, open pop progressions in C / G."
            },
            sad: {
                label: "Sad",
                emoji: "üò¢",
                description: "Minor progressions, soft dynamics."
            },
            inspired: {
                label: "Inspired",
                emoji: "‚ú®",
                description: "Maj7, add9 and open chords for an uplifting feel."
            },
            anger: {
                label: "Anger",
                emoji: "üò°",
                description: "Power-chord-like shapes, muted hits, tense moves."
            },
            ashamed: {
                label: "Ashamed",
                emoji: "üôà",
                description: "Tension‚Äìresolution, dim and minor7 colours."
            },
            loved: {
                label: "Loved",
                emoji: "‚ù§Ô∏è",
                description: "Warm, gentle, lots of maj7 and 7th chords."
            }
        };

        const emotions = Object.keys(baseEmotions).reduce((acc, key) => {
            acc[key] = { ...baseEmotions[key], styles: {} };
            return acc;
        }, {});

        Object.entries(styleProgressions).forEach(([styleKey, progressions]) => {
            progressions.forEach(prog => {
                prog.emotions.forEach(emotionKey => {
                    const emo = emotions[emotionKey];
                    if (!emo) return;
                    if (!emo.styles[styleKey]) {
                        emo.styles[styleKey] = { progressions: [] };
                    }
                    emo.styles[styleKey].progressions.push(prog);
                });
            });
        });
        function ensureEmotionStyleBucket(emotionKey, styleKey) {
            const emotion = emotions[emotionKey];
            if (!emotion) return null;
            if (!emotion.styles[styleKey]) {
                emotion.styles[styleKey] = { progressions: [] };
            }
            return emotion.styles[styleKey];
        }

        function addFavoriteProgressionToLoved(key, entry) {
            const bucket = ensureEmotionStyleBucket("loved", entry.style);
            if (!bucket) return;
            bucket.progressions.push({
                name: entry.name,
                chords: entry.chords.slice(),
                pattern: entry.pattern,
                technique: entry.technique,
                extra: entry.extra,
                emotions: ["loved"],
                __progressionKey: key
            });
        }

        function removeFavoriteProgressionFromLoved(key) {
            const lovedBucket = emotions.loved?.styles;
            if (!lovedBucket) return;
            Object.values(lovedBucket).forEach(bucket => {
                bucket.progressions = bucket.progressions.filter(prog => prog.__progressionKey !== key);
            });
        }

        function syncFavoritesIntoLoved() {
            const loved = emotions.loved;
            if (!loved) return;
            loved.styles = {};
            Object.entries(favoriteProgressions).forEach(([key, entry]) => {
                addFavoriteProgressionToLoved(key, entry);
            });
        }

        syncFavoritesIntoLoved();
        // ---------- Audio engine ----------
        let audioCtx = null;

        function getAudioContext() {
            if (!audioCtx) {
                const AC = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AC();
            }
            if (audioCtx.state === "suspended") {
                audioCtx.resume();
            }
            return audioCtx;
        }

        let currentTransposition = 0;
        const transposeLimit = 6;

        function playChord(chordName, startTime, duration = 0.8) {
            const ctx = getAudioContext();
            const notes = chords[chordName] || [];
            notes.forEach(note => {
                const freq = getNoteFrequency(note);
                if (!freq) return;
                const pitch = freq * Math.pow(2, currentTransposition / 12);

                const osc = ctx.createOscillator();
                const gain = ctx.createGain();

                osc.type = "triangle";
                osc.frequency.value = pitch;

                gain.gain.setValueAtTime(0, startTime);
                gain.gain.linearRampToValueAtTime(0.3, startTime + 0.05);
                gain.gain.linearRampToValueAtTime(0.0001, startTime + duration);

                osc.connect(gain);
                gain.connect(ctx.destination);

                osc.start(startTime);
                osc.stop(startTime + duration + 0.05);
            });
        }

        function playProgressionObject(prog) {
            const ctx = getAudioContext();
            const spacing = 0.9;
            let now = ctx.currentTime + 0.05;
            prog.chords.forEach((chordName, idx) => {
                playChord(chordName, now + idx * spacing, 0.8);
            });
        }

        // ---------- UI wiring ----------
        const emotionsContainer = document.getElementById("emotions");
        const progressionEl = document.getElementById("progression");
        const replayBtn = document.getElementById("replayBtn");
        const favoriteBtn = document.getElementById("favoriteBtn");
        const metaNameEl = document.getElementById("metaName");
        const metaPatternEl = document.getElementById("metaPattern");
        const metaTechniqueEl = document.getElementById("metaTechnique");
        const styleButtons = document.querySelectorAll(".style-btn");
        const chordDrawer = document.getElementById("chordDrawer");
        const chordDrawerGrid = document.getElementById("chordDrawerGrid");
        const chordModal = document.getElementById("chordModal");
        const chordModalGrid = document.getElementById("chordModalGrid");
        const chordModalClose = document.getElementById("chordModalClose");
        const chordModalBackdrop = chordModal?.querySelector(".chord-modal__backdrop");
        const transposeValueEl = document.getElementById("transposeValue");
        const transposeButtons = document.querySelectorAll(".transpose-btn");

        let currentEmotionKey = null;
        let currentProgIndex = null;
        let currentProgressionStyleKey = null;
        const activeStyleKeys = new Set(Object.keys(guitarStyles));

        function safeMetaValue(value) {
            return value && value.trim() ? value : "‚Äî";
        }

        function buildPatternText(prog, styleKey) {
            const modifier = guitarStyles[styleKey];
            const basePattern = prog.pattern || "‚Äî";
            const suffix = modifier?.patternSuffix ? ` ${modifier.patternSuffix}` : "";
            return basePattern + suffix;
        }

        function buildTechniqueText(prog, styleKey) {
            const modifier = guitarStyles[styleKey];
            const parts = [];
            if (prog.technique) parts.push(prog.technique);
            if (modifier?.techniqueNote) parts.push(modifier.techniqueNote);
            return parts.join(" ");
        }

        function getProgressionKey(styleKey, progName) {
            return `${styleKey}|${progName}`;
        }

        function prepareProgressionChords(styleKey, prog) {
            const key = getProgressionKey(styleKey, prog.name);
            currentProgressionKey = key;
            currentProgRef = prog;
            const override = customChordProgressions[key];
            if (Array.isArray(override)) {
                return override.slice();
            }
            return prog.chords.slice();
        }

        function createChordSvg(chordName) {
            const data = chordDiagrams[chordName] || {};
            const positions = data.positions || [-1, 0, 0, 0, 0, 0];
            const width = 96;
            const height = 90;
            const margin = 12;
            const top = margin;
            const bottom = height - margin;
            const left = margin;
            const right = width - margin;
            const stringSpacing = (right - left) / 5;
            const fretCount = 6;
            const fretSpacing = (bottom - top) / (fretCount - 1);
            const svg = document.createElementNS(CHORD_SVG_NS, "svg");
            svg.setAttribute("viewBox", `0 0 ${width} ${height}`);
            svg.classList.add("chord-card__svg");

            for (let i = 0; i < 6; i++) {
                const x = left + i * stringSpacing;
                const line = document.createElementNS(CHORD_SVG_NS, "line");
                line.setAttribute("x1", x);
                line.setAttribute("x2", x);
                line.setAttribute("y1", top);
                line.setAttribute("y2", bottom);
                line.setAttribute("stroke", "rgba(255, 255, 255, 0.15)");
                line.setAttribute("stroke-width", 1);
                svg.appendChild(line);
            }

            for (let i = 0; i < fretCount; i++) {
                const y = top + i * fretSpacing;
                const line = document.createElementNS(CHORD_SVG_NS, "line");
                line.setAttribute("x1", left);
                line.setAttribute("x2", right);
                line.setAttribute("y1", y);
                line.setAttribute("y2", y);
                line.setAttribute("stroke", "rgba(255, 255, 255, 0.25)");
                line.setAttribute("stroke-width", i === 0 ? 3 : 1);
                svg.appendChild(line);
            }

            if (data.barre) {
                const { fret, from, to } = data.barre;
                const startX = left + (from - 1) * stringSpacing - 4;
                const endX = left + (to - 1) * stringSpacing + 4;
                const y = top + (fret - 0.5) * fretSpacing - 6;
                const rect = document.createElementNS(CHORD_SVG_NS, "rect");
                rect.setAttribute("x", startX);
                rect.setAttribute("y", y);
                rect.setAttribute("width", endX - startX);
                rect.setAttribute("height", 12);
                rect.setAttribute("rx", 6);
                rect.setAttribute("fill", "rgba(255, 179, 71, 0.45)");
                svg.appendChild(rect);
            }

            positions.forEach((pos, idx) => {
                const x = left + idx * stringSpacing;
                if (pos === -1) {
                    const text = document.createElementNS(CHORD_SVG_NS, "text");
                    text.setAttribute("x", x);
                    text.setAttribute("y", top - 4);
                    text.setAttribute("text-anchor", "middle");
                    text.setAttribute("font-size", "10");
                    text.setAttribute("fill", "#f5c26b");
                    text.textContent = "√ó";
                    svg.appendChild(text);
                    return;
                }
                if (pos === 0) {
                    const circle = document.createElementNS(CHORD_SVG_NS, "circle");
                    circle.setAttribute("cx", x);
                    circle.setAttribute("cy", top - 4);
                    circle.setAttribute("r", 4);
                    circle.setAttribute("fill", "none");
                    circle.setAttribute("stroke", "rgba(255, 179, 71, 0.9)");
                    circle.setAttribute("stroke-width", 2);
                    svg.appendChild(circle);
                    return;
                }
                const y = top + (pos - 0.5) * fretSpacing;
                const circle = document.createElementNS(CHORD_SVG_NS, "circle");
                circle.setAttribute("cx", x);
                circle.setAttribute("cy", y);
                circle.setAttribute("r", 5);
                circle.setAttribute("fill", "rgba(255, 179, 71, 0.95)");
                circle.setAttribute("stroke", "rgba(0, 0, 0, 0.4)");
                circle.setAttribute("stroke-width", 1);
                svg.appendChild(circle);
            });

            return svg;
        }

        function createChordCard(chordObj, isActive) {
            const card = document.createElement("div");
            card.className = "chord-card" + (isActive ? " is-active" : "");
            const svg = createChordSvg(chordObj.original);
            const label = document.createElement("span");
            label.className = "chord-card__label";
            label.textContent = chordObj.label;
            card.appendChild(svg);
            card.appendChild(label);
            return card;
        }

        function showChordDrawer(chords, activeIndex = 0) {
            if (!chordDrawer || !chordDrawerGrid) return;
            chordDrawerGrid.innerHTML = "";
            chords.forEach((chordObj, idx) => {
                const card = createChordCard(chordObj, idx === activeIndex);
                setupChordCardInteractions(card, idx);
                chordDrawerGrid.appendChild(card);
            });
            currentActiveChord = chords[activeIndex]?.original || null;
        }

        function setupChordCardInteractions(card, idx) {
            if (!card) return;
            let holdTimer = null;
            let triggeredLongPress = false;

            const startHold = () => {
                triggeredLongPress = false;
                holdTimer = setTimeout(() => {
                    triggeredLongPress = true;
                    openChordModal(idx);
                }, LONG_PRESS_DELAY);
            };

            const cancelHold = () => {
                if (holdTimer) {
                    clearTimeout(holdTimer);
                    holdTimer = null;
                }
            };

            card.addEventListener("pointerdown", startHold);
            ["pointerup", "pointerleave", "pointercancel"].forEach(evt => {
                card.addEventListener(evt, cancelHold);
            });
            card.addEventListener("click", event => {
                if (triggeredLongPress) {
                    triggeredLongPress = false;
                    return;
                }
                if (idx === currentActiveChordIndex) {
                    openChordModal(idx);
                    return;
                }
                setActiveChordIndex(idx);
            });
        }

        function setActiveChordIndex(idx) {
            if (!currentTransposedChords.length) return;
            const boundedIndex = Math.max(0, Math.min(idx, currentTransposedChords.length - 1));
            currentActiveChordIndex = boundedIndex;
            currentActiveChord = currentTransposedChords[boundedIndex].original;
            showChordDrawer(currentTransposedChords, boundedIndex);
        }

        function openChordModal(index) {
            if (!chordModal || !chordModalGrid || !currentProgChords.length) return;
            modalTargetChordIndex = index;
            chordModalGrid.innerHTML = "";
            const activeChord = currentProgChords[index];
            chordOptions.forEach(chordName => {
                const card = createChordCard({ original: chordName, label: chordName }, chordName === activeChord);
                card.addEventListener("click", () => handleChordReplacement(chordName));
                chordModalGrid.appendChild(card);
            });
            chordModal.classList.add("is-visible");
            chordModal.setAttribute("aria-hidden", "false");
        }

        function closeChordModal() {
            if (!chordModal) return;
            chordModal.classList.remove("is-visible");
            chordModal.setAttribute("aria-hidden", "true");
            modalTargetChordIndex = null;
        }

        function persistCustomChordProgression() {
            if (!currentProgressionKey) return;
            customChordProgressions[currentProgressionKey] = currentProgChords.slice();
            persistMap(CUSTOM_PROGRESSIONS_KEY, customChordProgressions);
        }

        function handleChordReplacement(chordName) {
            if (modalTargetChordIndex === null || modalTargetChordIndex === undefined) return;
            currentProgChords[modalTargetChordIndex] = chordName;
            currentActiveChordIndex = modalTargetChordIndex;
            currentActiveChord = chordName;
            persistCustomChordProgression();
            if (isCurrentProgressionFavorited()) {
                updateFavoriteEntryChords(currentProgressionKey, currentProgChords);
            }
            refreshChordDisplay();
            closeChordModal();
        }

        function pickRandomIndex(arr) {
            return Math.floor(Math.random() * arr.length);
        }

        function renderProgression(emo, prog, styleKey, idx, listLength) {
            metaNameEl.textContent = prog.name;

            currentProgChords = prepareProgressionChords(styleKey, prog);
            currentActiveChordIndex = 0;
            currentActiveChord = currentProgChords[0] || null;
            refreshChordDisplay();

            metaPatternEl.textContent = buildPatternText(prog, styleKey);
            metaTechniqueEl.textContent = safeMetaValue(buildTechniqueText(prog, styleKey));

            updateFavoriteButtonState();
            replayBtn.disabled = false;
        }

        function isCurrentProgressionFavorited() {
            return !!(currentProgressionKey && favoriteProgressions[currentProgressionKey]);
        }

        function persistFavoriteProgressions() {
            persistMap(FAVORITE_PROGRESSIONS_KEY, favoriteProgressions);
        }

        function updateFavoriteButtonState() {
            if (!favoriteBtn) return;
            const isLoved = isCurrentProgressionFavorited();
            favoriteBtn.textContent = isLoved ? "‚ô•" : "‚ô°";
            favoriteBtn.classList.toggle("hearted", isLoved);
            favoriteBtn.setAttribute("aria-pressed", String(isLoved));
            favoriteBtn.disabled = !currentProgressionKey;
        }

        function buildFavoriteEntryFromCurrent() {
            if (!currentProgRef || !currentProgressionStyleKey) return null;
            return {
                name: currentProgRef.name,
                style: currentProgressionStyleKey,
                pattern: currentProgRef.pattern || "",
                technique: currentProgRef.technique || "",
                extra: currentProgRef.extra || "",
                chords: currentProgChords.slice(),
                sourceEmotion: currentEmotionKey
            };
        }

        function addCurrentProgressionToFavorites() {
            if (!currentProgressionKey) return;
            const entry = buildFavoriteEntryFromCurrent();
            if (!entry) return;
            favoriteProgressions[currentProgressionKey] = entry;
            persistFavoriteProgressions();
            addFavoriteProgressionToLoved(currentProgressionKey, entry);
        }

        function removeCurrentProgressionFromFavorites() {
            if (!currentProgressionKey) return;
            delete favoriteProgressions[currentProgressionKey];
            persistFavoriteProgressions();
            removeFavoriteProgressionFromLoved(currentProgressionKey);
        }

        function updateFavoriteEntryChords(key, chords) {
            const entry = favoriteProgressions[key];
            if (!entry) return;
            entry.chords = chords.slice();
            persistFavoriteProgressions();
            const lovedBucket = emotions.loved?.styles;
            if (!lovedBucket) return;
            Object.values(lovedBucket).forEach(bucket => {
                bucket.progressions.forEach(prog => {
                    if (prog.__progressionKey === key) {
                        prog.chords = chords.slice();
                    }
                });
            });
        }

        function refreshChordDisplay() {
            if (!progressionEl) return;
            progressionEl.innerHTML = "";
            if (!currentProgChords.length) {
                currentTransposedChords = [];
                showChordDrawer([], 0);
                return;
            }

            currentTransposedChords = currentProgChords.map((chord, idx) => ({
                original: chord,
                label: transposeChordName(chord, currentTransposition),
                index: idx
            }));

            currentTransposedChords.forEach((chordObj, idx) => {
                const span = document.createElement("span");
                span.className = "chord-pill";
                span.textContent = chordObj.label;
                span.setAttribute("role", "button");
                span.tabIndex = 0;
                span.dataset.index = String(idx);
                span.setAttribute("aria-label", chordObj.label + " chord diagram");
                span.addEventListener("click", () => setActiveChordIndex(idx));
                span.addEventListener("keydown", event => {
                    if (event.key === "Enter" || event.key === " ") {
                        event.preventDefault();
                        setActiveChordIndex(idx);
                    }
                });
                progressionEl.appendChild(span);
            });

            if (currentActiveChordIndex >= currentTransposedChords.length) {
                currentActiveChordIndex = 0;
            }
            currentActiveChord = currentTransposedChords[currentActiveChordIndex]?.original || currentProgChords[0];
            showChordDrawer(currentTransposedChords, currentActiveChordIndex);
        }

        function pickStyleForEmotion(emotionKey) {
            const emo = emotions[emotionKey];
            if (!emo) return null;
            const availableStyles = Object.keys(emo.styles).filter(style => activeStyleKeys.has(style));
            if (!availableStyles.length) return null;
            return availableStyles[pickRandomIndex(availableStyles)];
        }

        function setActiveEmotion(key) {
            currentEmotionKey = key;
            const emo = emotions[key];
            if (!emo) return null;

            document.querySelectorAll(".emotion-btn").forEach(btn => {
                btn.classList.toggle("active", btn.dataset.emotion === key);
            });

            const styleKey = pickStyleForEmotion(key);
            if (!styleKey) return null;

            const styleBucket = emo.styles[styleKey];
            if (!styleBucket || !styleBucket.progressions.length) return null;

            const idx = pickRandomIndex(styleBucket.progressions);
            const prog = styleBucket.progressions[idx];
            currentProgIndex = idx;
            currentProgressionStyleKey = styleKey;

            renderProgression(emo, prog, styleKey, idx, styleBucket.progressions.length);
            return prog;
        }

        function updateStyleButtons() {
            styleButtons.forEach(btn => {
                const styleKey = btn.dataset.style;
                const isActive = activeStyleKeys.has(styleKey);
                btn.classList.toggle("active", isActive);
                btn.setAttribute("aria-pressed", String(isActive));
            });
        }

        styleButtons.forEach(btn => {
            btn.addEventListener("click", () => {
                const styleKey = btn.dataset.style;
                if (!guitarStyles[styleKey]) return;
                if (activeStyleKeys.has(styleKey)) {
                    if (activeStyleKeys.size === 1) {
                        return;
                    }
                    activeStyleKeys.delete(styleKey);
                } else {
                    activeStyleKeys.add(styleKey);
                }
                updateStyleButtons();
                if (currentEmotionKey) {
                    const prog = setActiveEmotion(currentEmotionKey);
                    if (prog) {
                        playProgressionObject(prog);
                    }
                }
            });
        });

        if (favoriteBtn) {
            favoriteBtn.addEventListener("click", () => {
                if (isCurrentProgressionFavorited()) {
                    removeCurrentProgressionFromFavorites();
                } else {
                    addCurrentProgressionToFavorites();
                }
                updateFavoriteButtonState();
            });
        }

        function updateTransposeUi() {
            if (transposeValueEl) {
                transposeValueEl.textContent = currentTransposition > 0 ? `+${currentTransposition}` : `${currentTransposition}`;
            }
            transposeButtons.forEach(btn => {
                const action = btn.dataset.transposeAction;
                if (action === "increment") {
                    btn.disabled = currentTransposition >= transposeLimit;
                } else if (action === "decrement") {
                    btn.disabled = currentTransposition <= -transposeLimit;
                }
            });
        }

        transposeButtons.forEach(btn => {
            btn.addEventListener("click", () => {
                const action = btn.dataset.transposeAction;
                if (!action) return;
                const delta = action === "increment" ? 1 : -1;
                const nextValue = currentTransposition + delta;
                if (nextValue > transposeLimit || nextValue < -transposeLimit) return;
                currentTransposition = nextValue;
                updateTransposeUi();
                refreshChordDisplay();
            });
        });

        updateStyleButtons();
        updateTransposeUi();

        const defaultProg = setActiveEmotion("happy");
        if (defaultProg) {
            playProgressionObject(defaultProg);
        }

        emotionsContainer.addEventListener("click", e => {
            const btn = e.target.closest(".emotion-btn");
            if (!btn) return;
            const key = btn.dataset.emotion;
            if (!key) return;

            const prog = setActiveEmotion(key);
            if (prog) {
                playProgressionObject(prog);
            }
        });

        replayBtn.addEventListener("click", () => {
            if (!currentEmotionKey || currentProgIndex === null || !currentProgressionStyleKey) return;
            const emo = emotions[currentEmotionKey];
            if (!emo) return;
            const styleBucket = emo.styles[currentProgressionStyleKey];
            if (!styleBucket) return;
            const prog = styleBucket.progressions[currentProgIndex];
            if (!prog) return;
            playProgressionObject(prog);
        });

        if (chordModalClose) {
            chordModalClose.addEventListener("click", closeChordModal);
        }

        if (chordModalBackdrop) {
            chordModalBackdrop.addEventListener("click", closeChordModal);
        }

        if (chordModal) {
            chordModal.addEventListener("click", event => {
                if (event.target === chordModal) {
                    closeChordModal();
                }
            });
        }

        window.addEventListener("keydown", event => {
            if (event.key === "Escape") {
                closeChordModal();
            }
        });

        const installBanner = document.getElementById("installBanner");
        const installBtn = document.getElementById("installBtn");
        const installDismiss = document.getElementById("installDismiss");
        const INSTALL_FLAG = "feel-string-install-dismissed";
        let deferredPrompt = null;

        function showInstallBanner() {
            if (!installBanner) return;
            installBanner.classList.add("is-visible");
        }

        function hideInstallBanner() {
            if (!installBanner) return;
            installBanner.classList.remove("is-visible");
        }

        function markInstallBannerDone() {
            try {
                localStorage.setItem(INSTALL_FLAG, "true");
            } catch (err) {
                // ignore (private mode)
            }
        }

        function shouldPromptInstall() {
            try {
                return !localStorage.getItem(INSTALL_FLAG);
            } catch (err) {
                return true;
            }
        }

        window.addEventListener("beforeinstallprompt", event => {
            if (!shouldPromptInstall()) return;
            event.preventDefault();
            deferredPrompt = event;
            showInstallBanner();
        });

        if (installBtn) {
            installBtn.addEventListener("click", async () => {
                if (!deferredPrompt) return;
                hideInstallBanner();
                deferredPrompt.prompt();
                const choice = await deferredPrompt.userChoice;
                deferredPrompt = null;
                if (choice.outcome === "accepted") {
                    markInstallBannerDone();
                } else {
                    showInstallBanner();
                }
            });
        }

        if (installDismiss) {
            installDismiss.addEventListener("click", () => {
                hideInstallBanner();
                markInstallBannerDone();
            });
        }

        window.addEventListener("appinstalled", () => {
            markInstallBannerDone();
            hideInstallBanner();
        });

        // ---------- PWA: service worker registration (optional) ----------
        if ("serviceWorker" in navigator) {
            window.addEventListener("load", () => {
                navigator.serviceWorker
                    .register("service-worker.js")
                    .catch(err => console.warn("SW registration failed", err));
            });
        }
    </script>

</body>

</html>
